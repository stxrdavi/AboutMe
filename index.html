<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AboutMe</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Stili di base per entrambi i temi */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            transition: background 0.5s ease; /* Transizione fluida per i cambi di sfondo */
        }

        /* Modalit√† Scura */
        body.dark-mode {
            background: linear-gradient(135deg, #1a202c, #2d3748); /* Gradiente scuro predefinito */
            color: #f0f0f0; /* Testo chiaro per sfondi scuri */
        }
        body.dark-mode .glass-container {
            background-color: rgba(255, 255, 255, 0.08); /* Traslucenza pi√π sottile per la modalit√† scura */
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode .glass-container h1,
        body.dark-mode .glass-container h2,
        body.dark-mode .glass-container h3,
        body.dark-mode .glass-container p {
            color: #f0f0f0; /* Testo chiaro per titoli ed etichette */
        }
        body.dark-mode .profile-img {
            border: 5px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .link-button,
        body.dark-mode .merch-button {
            background-color: rgba(255, 255, 255, 0.15);
            color: #f0f0f0; /* Testo chiaro per i pulsanti in modalit√† scura */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .link-button:hover,
        body.dark-mode .merch-button:hover {
            background-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .merch-item {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .merch-img {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode input[type="text"],
        body.dark-mode input[type="url"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"],
        body.dark-mode textarea,
        body.dark-mode select {
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: #f0f0f0; /* Testo chiaro per gli input */
        }
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: rgba(240, 240, 240, 0.7); /* Testo placeholder pi√π chiaro */
        }
        body.dark-mode select {
            color: #f0f0f0;
        }
        body.dark-mode select:focus {
            background-color: rgba(255, 255, 255, 0.25);
        }
        body.dark-mode .text-gray-800 { color: #f0f0f0; }
        body.dark-mode .text-gray-700 { color: #d0d0d0; }
        body.dark-mode .text-gray-600 { color: #a0a0a0; }
        body.dark-mode .text-gray-500 { color: #808080; }
        body.dark-mode .bg-white { background-color: rgba(255, 255, 255, 0.1) !important; }
        body.dark-mode .border-white { border-color: rgba(255, 255, 255, 0.2) !important; }


        /* Modalit√† Chiara */
        body.light-mode {
            background: linear-gradient(135deg, #a7bfe8, #6190e8); /* Gradiente chiaro predefinito */
            color: #333; /* Testo scuro per sfondi chiari */
        }
        body.light-mode .glass-container {
            background-color: rgba(255, 255, 255, 0.2); /* Sfondo bianco traslucido */
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        body.light-mode .glass-container h1,
        body.light-mode .glass-container h2,
        body.light-mode .glass-container h3,
        body.light-mode .glass-container p {
            color: #333; /* Testo scuro per titoli ed etichette */
        }
        body.light-mode .profile-img {
            border: 5px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        body.light-mode .link-button,
        body.light-mode .merch-button {
            background-color: rgba(255, 255, 255, 0.3);
            color: #333; /* Testo scuro per i pulsanti in modalit√† chiara */
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        body.light-mode .link-button:hover,
        body.light-mode .merch-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        body.light-mode .merch-item {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        body.light-mode .merch-img {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        body.light-mode input[type="text"],
        body.light-mode input[type="url"],
        body.light-mode input[type="email"],
        body.light-mode input[type="password"],
        body.light-mode textarea,
        body.light-mode select {
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #333; /* Testo scuro per gli input */
        }
        body.light-mode input::placeholder,
        body.light-mode textarea::placeholder {
            color: rgba(51, 51, 51, 0.7); /* Testo placeholder pi√π scuro */
        }
        body.light-mode select {
            color: #333;
        }
        body.light-mode select:focus {
            background-color: rgba(255, 255, 255, 0.7);
        }
        body.light-mode .text-gray-800 { color: #333; }
        body.light-mode .text-gray-700 { color: #555; }
        body.light-mode .text-gray-600 { color: #777; }
        body.light-mode .text-gray-500 { color: #999; }
        body.light-mode .bg-white { background-color: rgba(255, 255, 255, 0.5) !important; }
        body.light-mode .border-white { border-color: rgba(255, 255, 255, 0.6) !important; }


        /* Stili comuni del contenitore di vetro */
        .glass-container {
            backdrop-filter: blur(15px); /* Effetto sfocatura vetro liquido */
            -webkit-backdrop-filter: blur(15px); /* Supporto Safari */
            border-radius: 2rem; /* Angoli pi√π arrotondati */
            padding: 2.5rem;
            margin-top: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px; /* Larghezza massima per il contenuto */
        }
        .profile-img {
            width: 140px; /* Immagine del profilo leggermente pi√π grande */
            height: 140px;
            object-fit: cover;
            border-radius: 50%;
        }
        .link-button, .merch-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .merch-item {
            border-radius: 1rem;
            padding: 1rem;
            transition: transform 0.2s ease;
        }
        .merch-item:hover {
            transform: translateY(-5px);
        }
        .merch-img {
            border-radius: 0.75rem;
            width: 100%;
            height: 180px; /* Altezza fissa per coerenza */
            object-fit: cover;
        }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.5rem; }
        input[type="color"]::-moz-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-moz-color-swatch { border: none; border-radius: 0.5rem; }

        /* Stili Modale Autenticazione */
        .auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .auth-modal-overlay.auth-modal-active {
            opacity: 1;
            visibility: visible;
        }
        .auth-modal-content {
            background-color: rgba(255, 255, 255, 0.15); /* Sfondo traslucido */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0; /* Testo chiaro per la modale */
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .auth-modal-overlay.auth-modal-active .auth-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .auth-modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #f0f0f0;
        }
        .auth-modal-content.light-mode-modal .auth-modal-close-btn {
            color: #333;
        }
        .auth-modal-content input[type="email"],
        .auth-modal-content input[type="password"] {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
        }
        .auth-modal-content.light-mode-modal input[type="email"],
        .auth-modal-content.light-mode-modal input[type="password"] {
            background-color: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #333;
        }
        .auth-modal-content input::placeholder {
            color: rgba(240, 240, 240, 0.6);
        }
        .auth-modal-content.light-mode-modal input::placeholder {
            color: rgba(51, 51, 51, 0.6);
        }
        .auth-modal-content .text-gray-700 {
            color: #f0f0f0;
        }
        .auth-modal-content.light-mode-modal .text-gray-700 {
            color: #333;
        }
        .auth-modal-content .text-gray-500 {
            color: #a0a0a0;
        }
        .auth-modal-content.light-mode-modal .text-gray-500 {
            color: #777;
        }

        /* Stili Casella Messaggi */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Superiore alla modale di autenticazione */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-box-overlay.message-box-active {
            opacity: 1;
            visibility: visible;
        }
        .message-box-content {
            background-color: rgba(255, 255, 255, 0.95); /* Quasi opaco per chiarezza */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
            color: #333;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .message-box-overlay.message-box-active .message-box-content {
            transform: translateY(0);
            opacity: 1;
        }
        .message-box-content.dark-mode-message-box {
            background-color: rgba(45, 55, 72, 0.95);
            color: #f0f0f0;
        }

        /* Stili Drag & Drop Immagine */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
        }
        .dark-mode .upload-area {
            border-color: rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .light-mode .upload-area {
            border-color: rgba(0, 0, 0, 0.3);
            background-color: rgba(0, 0, 0, 0.05);
        }
        .upload-area:hover {
            border-color: #6190e8; /* Colore accento al passaggio del mouse */
            background-color: rgba(97, 144, 232, 0.1);
        }
        .upload-area img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Stili per il pulsante mostra/nascondi password */
        .toggle-password-btn {
            position: absolute;
            right: 0.75rem; /* Posizionamento a destra */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem; /* Rende pi√π facile il click */
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toggle-password-btn:hover {
            background-color: rgba(255, 255, 255, 0.1); /* Effetto hover sottile */
        }
        .eye-icon {
            width: 20px; /* Dimensione dell'icona */
            height: 20px;
            stroke: currentColor; /* Usa il colore del testo ereditato */
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none; /* Assicurati che non ci sia riempimento */
        }
        /* Adatta il colore dell'icona al tema */
        body.dark-mode .eye-icon {
            color: #f0f0f0; /* Icona chiara per dark mode */
        }
        body.light-mode .eye-icon {
            color: #333; /* Icona scura per light mode */
        }

        /* Stili Chatbot */
        .chatbot-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Sotto la message box e la auth modal */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .chatbot-modal-overlay.chatbot-modal-active {
            opacity: 1;
            visibility: visible;
        }
        .chatbot-modal-content {
            background-color: rgba(255, 255, 255, 0.15); /* Sfondo traslucido */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            height: 80vh; /* Altezza fissa per la chat */
            max-height: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .chatbot-modal-overlay.chatbot-modal-active .chatbot-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .chatbot-modal-content.light-mode-modal {
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .chatbot-modal-content .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            background-color: rgba(0, 0, 0, 0.05); /* Sfondo per i messaggi */
            display: flex;
            flex-direction: column;
        }
        .chatbot-modal-content.light-mode-modal .chat-messages {
            background-color: rgba(0, 0, 0, 0.02);
        }
        .chatbot-modal-content input[type="text"] {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
        }
        .chatbot-modal-content.light-mode-modal input[type="text"] {
            background-color: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #333;
        }
        .chatbot-modal-content input::placeholder {
            color: rgba(240, 240, 240, 0.6);
        }
        .chatbot-modal-content.light-mode-modal input::placeholder {
            color: rgba(51, 51, 51, 0.6);
        }

        /* Loading indicator for chatbot */
        .chatbot-loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6190e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        .light-mode .chatbot-loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #6190e8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Regolazioni Responsive */
        @media (max-width: 768px) {
            .glass-container {
                padding: 1.5rem;
            }
            .profile-img {
                width: 100px;
                height: 100px;
            }
            .auth-modal-content, .message-box-content, .chatbot-modal-content {
                padding: 1.5rem;
            }
            .chatbot-modal-content {
                height: 90vh; /* Pi√π alto su mobile */
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 dark-mode">

    <!-- Pulsante Toggle Tema -->
    <button id="theme-toggle" class="fixed top-4 right-4 p-3 rounded-full bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg shadow-lg z-50 transition duration-300 hover:scale-105">
        <span id="theme-toggle-icon" class="text-gray-800 dark:text-white text-2xl">
            <!-- Icona Sole (predefinita per la modalit√† scura) -->
            ‚òÄÔ∏è
        </span>
    </button>

    <!-- Pulsante Logout (Nascosto fino all'accesso) -->
    <button id="logout-button" class="fixed top-4 left-4 p-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg z-50 transition duration-300 hover:scale-105 hidden" data-i18n="logout_button">Logout</button>

    <!-- Pulsante Assistente AI -->
    <button id="chatbot-toggle-btn" class="fixed bottom-4 right-4 p-4 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-2xl shadow-lg z-50 transition duration-300 hover:scale-110 cursor-pointer">
        ü§ñ
    </button>

    <!-- Casella Messaggi per Avvisi/Conferme -->
    <div id="message-box" class="message-box-overlay hidden">
        <div class="message-box-content dark:bg-gray-800 dark:text-gray-100">
            <p id="message-box-text" class="mb-4 text-gray-800 dark:text-gray-100"></p>
            <div class="flex justify-center gap-4">
                <button id="message-box-ok" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200"></button>
                <button id="message-box-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200 dark:bg-gray-600 dark:hover:bg-gray-700 dark:text-gray-100"></button>
            </div>
        </div>
    </div>

    <!-- Modale Autenticazione -->
    <div id="auth-modal" class="auth-modal-overlay hidden">
        <div class="auth-modal-content text-center">
            <button id="auth-modal-close" class="auth-modal-close-btn">&times;</button>
            <h2 id="auth-modal-title" class="text-3xl font-bold mb-6"></h2>
            <p id="auth-message" class="text-red-400 mb-4"></p>

            <!-- Modulo Login -->
            <div id="login-form">
                <div class="mb-4">
                    <label for="auth-email" class="block text-gray-700 text-sm font-bold mb-2 text-left" data-i18n="auth_email">Email:</label>
                    <input type="email" id="auth-email" placeholder="email@example.com" class="w-full p-3 rounded-lg border border-opacity-40 text-gray-800 dark:text-gray-100">
                </div>
                <div class="mb-6">
                    <label for="auth-password" class="block text-gray-700 text-sm font-bold mb-2 text-left" data-i18n="auth_password">Password:</label>
                    <div class="relative">
                        <input type="password" id="auth-password" placeholder="********" class="w-full p-3 rounded-lg border border-opacity-40 text-gray-800 dark:text-gray-100 pr-10 password-input">
                        <button type="button" id="toggle-password-login" class="toggle-password-btn">
                            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="login-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-lg w-full mb-4" data-i18n="auth_login_button">Login</button>
                <p class="text-sm text-gray-500 mb-2">
                    <a href="#" id="forgot-password-link" class="text-blue-400 hover:underline" data-i18n="auth_forgot_password">Password Dimenticata?</a>
                </p>
                <p class="text-sm text-gray-500">
                    <a href="#" id="go-to-register" class="text-blue-400 hover:underline" data-i18n="auth_go_to_register">Non hai un account? Registrati</a>
                </p>
            </div>

            <!-- Modulo Registrazione -->
            <div id="register-form" class="hidden">
                <div class="mb-4">
                    <label for="auth-email-register" class="block text-gray-700 text-sm font-bold mb-2 text-left" data-i18n="auth_email">Email:</label>
                    <input type="email" id="auth-email-register" placeholder="email@example.com" class="w-full p-3 rounded-lg border border-opacity-40 text-gray-800 dark:text-gray-100">
                </div>
                <div class="mb-4">
                    <label for="auth-password-register" class="block text-gray-700 text-sm font-bold mb-2 text-left" data-i18n="auth_password">Password:</label>
                    <div class="relative">
                        <input type="password" id="auth-password-register" placeholder="********" class="w-full p-3 rounded-lg border border-opacity-40 text-gray-800 dark:text-gray-100 pr-10 password-input">
                        <button type="button" id="toggle-password-register" class="toggle-password-btn">
                            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="auth-confirm-password-register" class="block text-gray-700 text-sm font-bold mb-2 text-left" data-i18n="auth_confirm_password">Conferma Password:</label>
                    <div class="relative">
                        <input type="password" id="auth-confirm-password-register" placeholder="********" class="w-full p-3 rounded-lg border border-opacity-40 text-gray-800 dark:text-gray-100 pr-10 password-input">
                        <button type="button" id="toggle-confirm-password-register" class="toggle-password-btn">
                            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    <p id="password-match-message" class="text-sm mt-2"></p>
                </div>
                <button id="register-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-lg w-full mb-4" data-i18n="auth_register_button">Registrati</button>
                <p class="text-sm text-gray-500">
                    <a href="#" id="go-to-login" class="text-blue-400 hover:underline" data-i18n="auth_go_to_login">Hai gi√† un account? Accedi</a>
                </p>
            </div>

            <!-- Modulo Password Dimenticata -->
            <div id="forgot-password-form" class="hidden">
                <div class="mb-4">
                    <label for="auth-forgot-email" class="block text-gray-700 text-sm font-bold mb-2 text-left" data-i18n="auth_email">Email:</label>
                    <input type="email" id="auth-forgot-email" placeholder="email@example.com" class="w-full p-3 rounded-lg border border-opacity-40 text-gray-800 dark:text-gray-100">
                </div>
                <button id="reset-password-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-lg w-full mb-4" data-i18n="auth_reset_password_button">Invia Email di Reimpostazione</button>
                <p class="text-sm text-gray-500">
                    <a href="#" id="go-to-login-from-forgot" class="text-blue-400 hover:underline" data-i18n="auth_go_to_login">Hai gi√† un account? Accedi</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Modale Chatbot AI -->
    <div id="chatbot-modal" class="chatbot-modal-overlay hidden">
        <div class="chatbot-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="chatbot_title">AboutMe AI Assistant</h2>
                <button id="chatbot-close-btn" class="text-gray-800 dark:text-white text-3xl leading-none cursor-pointer">&times;</button>
            </div>
            <div id="chat-messages" class="chat-messages flex flex-col space-y-2">
                <!-- I messaggi della chat verranno aggiunti qui -->
            </div>
            <div id="chatbot-loading" class="hidden text-center my-2">
                <div class="chatbot-loading-spinner"></div>
                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">AI sta pensando...</p>
            </div>
            <div class="flex mt-4">
                <input type="text" id="chat-input" placeholder="Scrivi il tuo messaggio..." class="flex-grow p-3 rounded-l-lg border border-opacity-40 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="chat-send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-r-lg transition duration-200" data-i18n="chatbot_send">Invia</button>
            </div>
        </div>
    </div>

    <!-- Sezione Pagina di Atterraggio -->
    <div id="landing-page" class="page-section glass-container w-full max-w-md mx-auto text-center">
        <h1 class="text-4xl font-bold mb-4" data-i18n="landing_welcome">Benvenuto su AboutMe!</h1>
        <p class="text-lg mb-8" data-i18n="landing_description">Crea la tua pagina personale, condividi i tuoi link e mostra il tuo merchandising. Accedi per iniziare!</p>
        <button id="signin-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-lg" data-i18n="landing_signin_button">Accedi / Registrati</button>
        <p class="text-gray-500 text-sm mt-4">ID Utente: <span id="current-user-id-display">N/A</span></p>
    </div>

    <!-- Sezione Dashboard -->
    <div id="dashboard-page" class="page-section glass-container w-full max-w-3xl mx-auto text-center hidden">
        <h1 class="text-4xl font-bold mb-6" data-i18n="dashboard_title">Le Tue Pagine AboutMe</h1>
        <p class="text-gray-500 text-sm mb-4">ID Utente: <span id="dashboard-user-id-display">N/A</span></p>
        <div id="dashboard-pages-list" class="grid grid-cols-1 gap-4 mb-8">
            <!-- Le pagine verranno caricate qui -->
            <p class="text-gray-600 text-center" data-i18n="dashboard_no_pages">Non hai ancora creato nessuna pagina.</p>
        </div>
        <button id="dashboard-create-new-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-lg" data-i18n="dashboard_create_new">Crea Nuova Pagina AboutMe</button>
    </div>

    <!-- Sezione Modulo Crea/Modifica -->
    <div id="create-edit-form" class="page-section glass-container w-full max-w-3xl mx-auto text-left hidden">
        <h2 id="create-edit-form-title" class="text-3xl font-semibold mb-6" data-i18n="create_edit_title_create">Crea Nuova Pagina AboutMe</h2>

        <div class="mb-4">
            <label for="form-name" class="block text-sm font-bold mb-2" data-i18n="form_name">Il Tuo Nome:</label>
            <input type="text" id="form-name" placeholder="John Doe" class="w-full p-3 rounded-lg bg-opacity-30 border border-opacity-40">
        </div>
        <div class="mb-4">
            <label for="form-tagline" class="block text-sm font-bold mb-2" data-i18n="form_tagline">La Tua Tagline:</label>
            <input type="text" id="form-tagline" placeholder="Creativo | Sviluppatore | Appassionato" class="w-full p-3 rounded-lg bg-opacity-30 border border-opacity-40">
        </div>
        <div class="mb-4">
            <label for="form-about-me" class="block text-sm font-bold mb-2" data-i18n="form_about_me">Descrizione About Me:</label>
            <textarea id="form-about-me" placeholder="Benvenuto nel mio spazio personale..." class="w-full p-3 rounded-lg bg-opacity-30 border border-opacity-40 h-32"></textarea>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-bold mb-2" data-i18n="form_profile_img">URL Immagine Profilo:</label>
            <div id="profile-img-upload-area" class="upload-area">
                <img id="profile-img-preview" src="https://placehold.co/140x140/6190e8/ffffff?text=Profile" alt="Anteprima Immagine Profilo">
                <p id="profile-img-upload-text" class="text-gray-600 dark:text-gray-300" data-i18n="form_profile_img_upload">Trascina & Rilascia o Clicca per Caricare Immagine Profilo</p>
                <input type="file" id="profile-img-file-input" accept="image/*" class="hidden">
            </div>
            <input type="hidden" id="form-profile-img-url-hidden"> <!-- Campo nascosto per l'URL dell'immagine -->
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold mb-3" data-i18n="form_links_title">Link (Nome, URL):</h3>
            <div id="form-links-container">
                <!-- Gli input dei link verranno aggiunti qui tramite JS -->
            </div>
            <button id="form-add-link-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200" data-i18n="form_add_link">Aggiungi Link</button>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold mb-3" data-i18n="form_merch_title">Merchandise (Nome, Descrizione, URL Immagine, Prezzo, Link Acquisto):</h3>
            <div id="form-merch-container">
                <!-- Gli input del merch verranno aggiunti qui tramite JS -->
            </div>
            <button id="form-add-merch-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200" data-i18n="form_add_merch">Aggiungi Articolo Merch</button>
        </div>

        <div class="flex justify-end gap-4 mt-8">
            <button id="form-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-xl transition duration-200 dark:bg-gray-600 dark:hover:bg-gray-700 dark:text-gray-100" data-i18n="form_cancel_button">Annulla</button>
            <button id="form-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-lg" data-i18n="form_save_button">Salva Pagina</button>
        </div>
    </div>

    <!-- Sezione Visualizzazione About Me (riutilizzo della struttura del codice precedente) -->
    <div id="about-me-display-page" class="page-section glass-container w-full max-w-2xl mx-auto text-center hidden">
        <!-- Sezione Profilo -->
        <div class="flex flex-col items-center mb-8">
            <img id="display-profile-img" src="https://placehold.co/140x140/6190e8/ffffff?text=Profile" alt="Immagine Profilo" class="profile-img mb-4">
            <h1 id="display-name" class="text-4xl font-bold mb-2" data-i18n="name">Il Tuo Nome Qui</h1>
            <p id="display-tagline" class="text-lg mb-4" data-i18n="tagline">Creativo | Sviluppatore | Appassionato</p>
            <p id="display-about-me-description" class="leading-relaxed max-w-prose" data-i18n="about_me_description">
                Benvenuto nel mio spazio personale! Sono appassionato di creare esperienze digitali coinvolgenti e di condividere il mio percorso. Qui troverai tutto su di me, i miei progetti e come connetterti.
            </p>
        </div>

        <!-- Sezione Link -->
        <div class="mb-8">
            <h2 class="text-3xl font-semibold mb-6" data-i18n="links_title">I Miei Link</h2>
            <div id="display-links-container" class="grid grid-cols-1 gap-4">
                <!-- I pulsanti dei link verranno caricati dinamicamente qui -->
            </div>
        </div>

        <!-- Sezione Merch -->
        <div>
            <h2 class="text-3xl font-semibold mb-6" data-i18n="merch_title">Il Mio Merch</h2>
            <div id="display-merch-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Gli articoli merch verranno caricati dinamicamente qui -->
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Le tue credenziali Supabase
        const SUPABASE_URL = 'https://fyncjiafbsmsjrfxtqyg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5bmNqaWFmYnNtc2pyZnh0cXlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1NTYxMzYsImV4cCI6MjA2NzEzMjEzNn0.fGkL6NPd6TNeo0zuC4VY8kJ79HNMWD9G8XVVbQrhEWo';

        // Inizializza il client Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client initialized:", supabase); // Debug: Conferma l'inizializzazione di Supabase

        let currentUserId = null;
        let isAuthReady = false;
        let currentlyVisiblePasswordInputId = null; // Variabile per tracciare la password attualmente visibile

        // Emoji per il tema
        const SUN_EMOJI = "‚òÄÔ∏è"; // Emoji Sole
        const MOON_EMOJI = "üåô"; // Emoji Luna

        // API Key per Gemini (fornita dall'utente)
        const GEMINI_API_KEY = ""; // Changed to empty string as per instructions
        let chatHistory = []; // Per memorizzare la cronologia della chat per l'assistente AI
        let selectedChatbotLanguage = 'en'; // Lingua predefinita per le risposte del chatbot
        const chatbotEmojis = ["üòä", "üëç", "‚ú®", "üöÄ", "üí°", "ü§ñ", "üåü"]; // Emoji per il chatbot

        // Funzione per ottenere un'emoji casuale dal chatbot
        function getRandomChatbotEmoji() {
            return chatbotEmojis[Math.floor(Math.random() * chatbotEmojis.length)];
        }

        // SVG Icons for password visibility
        const EYE_OPEN_SVG = `
            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        `;
        const EYE_CLOSED_SVG = `
            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.54 18.54 0 0 1 2.21-3.6l-1.39-1.39A1.003 1.003 0 0 0 1.29 5.29L2.71 3.87a1.003 1.003 0 0 0-1.42-1.42L.29 2.45a1.003 1.003 0 0 0 1.42 1.42L2.71 3.87a1.003 1.003 0 0 0 1.42 1.42zM12 9.5a2.5 2.5 0 0 0 0 5 2.5 2.5 0 0 0 0-5z"></path>
                <path d="M1 1l22 22"></path>
            </svg>
        `;


        // Oggetto delle traduzioni
        const translations = {
            en: {
                appName: "AboutMe",
                landing_welcome: "Welcome to AboutMe!",
                landing_description: "Create your personal page, share your links, and showcase your merchandise. Sign in to get started!",
                landing_signin_button: "Sign In / Register",
                dashboard_title: "Your AboutMe Pages",
                dashboard_no_pages: "You haven't created any pages yet.",
                dashboard_create_new: "Create New AboutMe Page",
                dashboard_view: "View",
                dashboard_edit: "Edit",
                dashboard_delete: "Delete",
                dashboard_copy_link: "Copy Link",
                dashboard_link_copied: "Link copied!",
                create_edit_title_create: "Create New AboutMe Page",
                create_edit_title_edit: "Edit AboutMe Page",
                form_name: "Your Name:",
                form_tagline: "Your Tagline:",
                form_about_me: "About Me Description:",
                form_profile_img: "Profile Image URL:",
                form_profile_img_upload: "Drag & Drop or Click to Upload Profile Image",
                form_links_title: "Links (Name, URL):",
                form_add_link: "Add Link",
                form_merch_title: "Merchandise (Name, Description, Image URL, Price, Buy Link):",
                form_add_merch: "Add Merch Item",
                form_save_button: "Save Page",
                form_cancel_button: "Cancel",
                about_me_page_title: "AboutMe Page",
                name: "Your Name Here",
                tagline: "Creative | Developer | Enthusiast",
                about_me_description: "Welcome to my personal space! I'm passionate about creating engaging digital experiences and sharing my journey. Here you'll find everything about me, my projects, and how to connect.",
                links_title: "My Links",
                link_portfolio: "Portfolio",
                link_github: "GitHub",
                link_linkedin: "LinkedIn",
                link_twitter: "Twitter",
                merch_title: "My Merch",
                merch_item_1_name: "Cool T-Shirt",
                merch_item_1_desc: "Comfortable and stylish, perfect for any occasion.",
                merch_item_2_name: "Awesome Mug",
                merch_item_2_desc: "Start your day with a sip of inspiration.",
                merch_item_3_name: "Cozy Hoodie",
                merch_item_3_desc: "Stay warm and show your support.",
                merch_buy_now: "Buy Now",
                settings_title: "Settings", // This will be removed, but kept for consistency in translations object
                select_language: "Select Language:", // This will be removed, but kept for consistency in translations object
                gradient_color_1: "Gradient Color 1:", // This will be removed, but kept for consistency in translations object
                gradient_color_2: "Gradient Color 2:", // This will be removed, but kept for consistency in translations object
                gradient_direction: "Gradient Direction (deg):", // This will be removed, but kept for consistency in translations object
                error_loading_page: "Error loading page: ",
                error_saving_page: "Error saving page: ",
                error_deleting_page: "Error deleting page: ",
                confirm_delete: "Are you sure you want to delete this page?",
                message_box_ok: "OK",
                message_box_cancel: "Cancel",
                auth_modal_title_login: "Login to AboutMe",
                auth_modal_title_register: "Register for AboutMe",
                auth_modal_title_forgot: "Reset Password",
                auth_email: "Email:",
                auth_password: "Password:",
                auth_show_password: "Show Password",
                auth_confirm_password: "Confirm Password:",
                auth_passwords_match: "Passwords match!",
                auth_passwords_no_match: "Passwords do not match!",
                auth_login_button: "Login",
                auth_register_button: "Register",
                auth_forgot_password: "Forgot Password?",
                auth_go_to_register: "Don't have an account? Register",
                auth_go_to_login: "Already have an account? Login",
                auth_reset_password_button: "Send Reset Email",
                auth_reset_email_sent: "Password reset email sent! Check your inbox.",
                auth_error_login: "Login failed: ",
                auth_error_register: "Registration failed: ",
                auth_error_reset: "Password reset failed: ",
                logout_button: "Logout",
                theme_toggle_label: "Toggle Theme",
                upload_success: "Image uploaded successfully!",
                upload_error: "Image upload failed: ",
                chatbot_title: "AboutMe AI Assistant",
                chatbot_input_placeholder: "Type your message...",
                chatbot_send: "Send",
                chatbot_external_query_response: "I'm designed to help with questions about this website only. I cannot provide information from external sites."
            },
            it: {
                appName: "AboutMe",
                landing_welcome: "Benvenuto su AboutMe!",
                landing_description: "Crea la tua pagina personale, condividi i tuoi link e mostra il tuo merchandising. Accedi per iniziare!",
                landing_signin_button: "Accedi / Registrati",
                dashboard_title: "Le Tue Pagine AboutMe",
                dashboard_no_pages: "Non hai ancora creato nessuna pagina.",
                dashboard_create_new: "Crea Nuova Pagina AboutMe",
                dashboard_view: "Visualizza",
                dashboard_edit: "Modifica",
                dashboard_delete: "Elimina",
                dashboard_copy_link: "Copia Link",
                dashboard_link_copied: "Link copiato!",
                create_edit_title_create: "Crea Nuova Pagina AboutMe",
                create_edit_title_edit: "Modifica Pagina AboutMe",
                form_name: "Il Tuo Nome:",
                form_tagline: "La Tua Tagline:",
                form_about_me: "Descrizione About Me:",
                form_profile_img: "URL Immagine Profilo:",
                form_profile_img_upload: "Trascina & Rilascia o Clicca per Caricare Immagine Profilo",
                form_links_title: "Link (Nome, URL):",
                form_add_link: "Aggiungi Link",
                form_merch_title: "Merchandise (Nome, Descrizione, URL Immagine, Prezzo, Link Acquisto):",
                form_add_merch: "Aggiungi Articolo Merch",
                form_save_button: "Salva Pagina",
                form_cancel_button: "Annulla",
                about_me_page_title: "Pagina AboutMe",
                name: "Il Tuo Nome Qui",
                tagline: "Creativo | Sviluppatore | Appassionato",
                about_me_description: "Benvenuto nel mio spazio personale! Sono appassionato di creare esperienze digitali coinvolgenti e di condividere il mio percorso. Qui troverai tutto su di me, i miei progetti e come connetterti.",
                links_title: "I Miei Link",
                link_portfolio: "Portfolio",
                link_github: "GitHub",
                link_linkedin: "LinkedIn",
                link_twitter: "Twitter",
                merch_title: "Il Mio Merch",
                merch_item_1_name: "T-Shirt Fantastica",
                merch_item_1_desc: "Comoda ed elegante, perfetta per ogni occasione.",
                merch_item_2_name: "Tazza Eccezionale",
                merch_item_2_desc: "Inizia la giornata con un sorso di ispirazione.",
                merch_item_3_name: "Felpa Comoda",
                merch_item_3_desc: "Rimani al caldo e mostra il tuo supporto.",
                merch_buy_now: "Acquista Ora",
                settings_title: "Impostazioni",
                select_language: "Seleziona Lingua:",
                gradient_color_1: "Colore Gradiente 1:",
                gradient_color_2: "Colore Gradiente 2:",
                gradient_direction: "Direzione Gradiente (gradi):",
                error_loading_page: "Errore durante il caricamento della pagina: ",
                error_saving_page: "Errore durante il salvataggio della pagina: ",
                error_deleting_page: "Errore durante l'eliminazione della pagina: ",
                confirm_delete: "Sei sicuro di voler eliminare questa pagina?",
                message_box_ok: "OK",
                message_box_cancel: "Annulla",
                auth_modal_title_login: "Accedi ad AboutMe",
                auth_modal_title_register: "Registrati ad AboutMe",
                auth_modal_title_forgot: "Reimposta Password",
                auth_email: "Email:",
                auth_password: "Password:",
                auth_show_password: "Mostra Password",
                auth_confirm_password: "Conferma Password:",
                auth_passwords_match: "Le password corrispondono!",
                auth_passwords_no_match: "Le password non corrispondono!",
                auth_login_button: "Accedi",
                auth_register_button: "Registrati",
                auth_forgot_password: "Password Dimenticata?",
                auth_go_to_register: "Non hai un account? Registrati",
                auth_go_to_login: "Hai gi√† un account? Accedi",
                auth_reset_password_button: "Invia Email di Reimpostazione",
                auth_reset_email_sent: "Email di reimpostazione password inviata! Controlla la tua casella di posta.",
                auth_error_login: "Accesso fallito: ",
                auth_error_register: "Registrazione fallita: ",
                auth_error_reset: "Reimpostazione password fallita: ",
                logout_button: "Esci",
                theme_toggle_label: "Cambia Tema",
                upload_success: "Immagine caricata con successo!",
                upload_error: "Caricamento immagine fallito: ",
                chatbot_title: "Assistente AI AboutMe",
                chatbot_input_placeholder: "Scrivi il tuo messaggio...",
                chatbot_send: "Invia",
                chatbot_external_query_response: "Sono progettato per rispondere solo a domande relative a questo sito web. Non posso fornire informazioni da siti esterni."
            },
            de: {
                appName: "AboutMe",
                landing_welcome: "Willkommen bei AboutMe!",
                landing_description: "Erstellen Sie Ihre pers√∂nliche Seite, teilen Sie Ihre Links und pr√§sentieren Sie Ihre Merchandise-Artikel. Melden Sie sich an, um loszulegen!",
                landing_signin_button: "Anmelden / Registrieren",
                dashboard_title: "Ihre AboutMe Seiten",
                dashboard_no_pages: "Sie haben noch keine Seiten erstellt.",
                dashboard_create_new: "Neue AboutMe Seite Erstellen",
                dashboard_view: "Anzeigen",
                dashboard_edit: "Bearbeiten",
                dashboard_delete: "L√∂schen",
                dashboard_copy_link: "Link Kopieren",
                dashboard_link_copied: "Link kopiert!",
                create_edit_title_create: "Neue AboutMe Seite Erstellen",
                create_edit_title_edit: "AboutMe Seite Bearbeiten",
                form_name: "Ihr Name:",
                form_tagline: "Ihr Slogan:",
                form_about_me: "√úber mich Beschreibung:",
                form_profile_img: "Profilbild-URL:",
                form_profile_img_upload: "Ziehen & Ablegen oder Klicken zum Hochladen des Profilbildes",
                form_links_title: "Links (Name, URL):",
                form_add_link: "Link Hinzuf√ºgen",
                form_merch_title: "Merchandise (Name, Beschreibung, Bild-URL, Preis, Kauflink):",
                form_add_merch: "Merch-Artikel Hinzuf√ºgen",
                form_save_button: "Seite Speichern",
                form_cancel_button: "Abbrechen",
                about_me_page_title: "AboutMe Seite",
                name: "Dein Name Hier",
                tagline: "Kreativ | Entwickler | Enthusiast",
                about_me_description: "Willkommen in meinem pers√∂nlichen Bereich! Ich bin leidenschaftlich daran interessiert, ansprechende digitale Erlebnisse zu schaffen und meine Reise zu teilen. Hier finden Sie alles √ºber mich, meine Projekte und wie Sie sich verbinden k√∂nnen.",
                links_title: "Meine Links",
                link_portfolio: "Portfolio",
                link_github: "GitHub",
                link_linkedin: "LinkedIn",
                link_twitter: "Twitter",
                merch_title: "Mein Merch",
                merch_item_1_name: "Cooles T-Shirt",
                merch_item_1_desc: "Bequem und stilvoll, perfekt f√ºr jeden Anlass.",
                merch_item_2_name: "Tolle Tasse",
                merch_item_2_desc: "Beginnen Sie Ihren Tag mit einem Schluck Inspiration.",
                merch_item_3_name: "Gem√ºtlicher Hoodie",
                merch_item_3_desc: "Bleiben Sie warm und zeigen Sie Ihre Unterst√ºtzung.",
                merch_buy_now: "Jetzt Kaufen",
                settings_title: "Einstellungen",
                select_language: "Sprache ausw√§hlen:",
                gradient_color_1: "Farbverlauf Farbe 1:",
                gradient_color_2: "Farbverlauf Farbe 2:",
                gradient_direction: "Farbverlauf Richtung (Grad):",
                error_loading_page: "Fehler beim Laden der Seite: ",
                error_saving_page: "Fehler beim Speichern der Seite: ",
                error_deleting_page: "Fehler beim L√∂schen der Seite: ",
                confirm_delete: "M√∂chten Sie diese Seite wirklich l√∂schen?",
                message_box_ok: "OK",
                message_box_cancel: "Abbrechen",
                auth_modal_title_login: "Bei AboutMe anmelden",
                auth_modal_title_register: "Bei AboutMe registrieren",
                auth_modal_title_forgot: "Passwort zur√ºcksetzen",
                auth_email: "E-Mail:",
                auth_password: "Passwort:",
                auth_show_password: "Passwort anzeigen",
                auth_confirm_password: "Passwort best√§tigen:",
                auth_passwords_match: "Passw√∂rter stimmen √ºberein!",
                auth_passwords_no_match: "Passw√∂rter stimmen nicht √ºberein!",
                auth_login_button: "Anmelden",
                auth_register_button: "Registrieren",
                auth_forgot_password: "Passwort vergessen?",
                auth_go_to_register: "Noch kein Konto? Registrieren",
                auth_go_to_login: "Bereits ein Konto? Anmelden",
                auth_reset_password_button: "E-Mail zum Zur√ºcksetzen senden",
                auth_reset_email_sent: "Passwort-Reset-E-Mail gesendet! √úberpr√ºfen Sie Ihren Posteingang.",
                auth_error_login: "Anmeldung fehlgeschlagen: ",
                auth_error_register: "Registrierung fehlgeschlagen: ",
                auth_error_reset: "Passwort-Reset fehlgeschlagen: "
            },
            fr: {
                appName: "AboutMe",
                landing_welcome: "Bienvenue sur AboutMe !",
                landing_description: "Cr√©ez votre page personnelle, partagez vos liens et pr√©sentez vos produits d√©riv√©s. Connectez-vous pour commencer !",
                landing_signin_button: "Se Connecter / S'inscrire",
                dashboard_title: "Vos Pages AboutMe",
                dashboard_no_pages: "Vous n'avez pas encore cr√©√© de pages.",
                dashboard_create_new: "Cr√©er une Nouvelle Page AboutMe",
                dashboard_view: "Afficher",
                dashboard_edit: "Modifier",
                dashboard_delete: "Supprimer",
                dashboard_copy_link: "Copier le Lien",
                dashboard_link_copied: "Lien copi√© !",
                create_edit_title_create: "Cr√©er une Nouvelle Page AboutMe",
                create_edit_title_edit: "Modifier la Page AboutMe",
                form_name: "Votre Nom :",
                form_tagline: "Votre Slogan :",
                form_about_me: "Description √Ä Propos de Moi :",
                form_profile_img: "URL de l'Image de Profil :",
                form_profile_img_upload: "Glisser-d√©poser ou Cliquer pour T√©l√©charger l'Image de Profil",
                form_links_title: "Liens (Nom, URL) :",
                form_add_link: "Ajouter un Lien",
                form_merch_title: "Produits D√©riv√©s (Nom, Description, URL de l'Image, Prix, Lien d'Achat) :",
                form_add_merch: "Ajouter un Article Merch",
                form_save_button: "Enregistrer la Page",
                form_cancel_button: "Annuler",
                about_me_page_title: "Page AboutMe",
                name: "Votre Nom Ici",
                tagline: "Cr√©atif | D√©veloppeur | Passionn√©",
                about_me_description: "Bienvenue dans mon espace personnel ! Je suis passionn√© par la cr√©ation d'exp√©riences num√©riques engageantes et le partage de mon parcours. Ici, vous trouverez tout sur moi, mes projets et comment me contacter.",
                links_title: "Mes Liens",
                link_portfolio: "Portfolio",
                link_github: "GitHub",
                link_linkedin: "LinkedIn",
                link_twitter: "Twitter",
                merch_title: "Mon Merch",
                merch_item_1_name: "T-Shirt Cool",
                merch_item_1_desc: "Confortable et √©l√©gant, parfait pour toute occasion.",
                merch_item_2_name: "Super Tasse",
                merch_item_2_desc: "Commencez votre journ√©e avec une gorg√©e d'inspiration.",
                merch_item_3_name: "Sweat √† Capuche Confortable",
                merch_item_3_desc: "Restez au chaud et montrez votre soutien.",
                merch_buy_now: "Acheter Maintenant",
                settings_title: "Param√®tres",
                select_language: "S√©lectionner la langue :",
                gradient_color_1: "Couleur du d√©grad√© 1 :",
                gradient_color_2: "Couleur du d√©grad√© 2 :",
                gradient_direction: "Direction du d√©grad√© (degr√©s) :",
                error_loading_page: "Erreur lors du caricamento de la page : ",
                error_saving_page: "Errore lors de l'enregistrement de la page : ",
                error_deleting_page: "Errore lors de la suppression de la page : ",
                confirm_delete: "√ätes-vous s√ªr de vouloir supprimer cette page ?",
                message_box_ok: "OK",
                message_box_cancel: "Annuler",
                auth_modal_title_login: "Se connecter √† AboutMe",
                auth_modal_title_register: "S'inscrire √† AboutMe",
                auth_modal_title_forgot: "R√©initialiser le mot de passe",
                auth_email: "E-mail :",
                auth_password: "Mot de passe :",
                auth_show_password: "Afficher le mot de passe",
                auth_confirm_password: "Confirmer le mot de passe :",
                auth_passwords_match: "Les mots de passe correspondent !",
                auth_passwords_no_match: "Les mots de passe ne correspondent pas !",
                auth_login_button: "Se connecter",
                auth_register_button: "S'inscrire",
                auth_forgot_password: "Mot de passe oubli√© ?",
                auth_go_to_register: "Pas encore de compte ? S'inscrire",
                auth_go_to_login: "D√©j√† un compte ? Se connecter",
                auth_reset_password_button: "Envoyer l'e-mail de r√©initialisation",
                auth_reset_email_sent: "E-mail de r√©initialisation du mot de passe envoy√© ! V√©rifiez votre bo√Æte de r√©ception.",
                auth_error_login: "√âchec de la connexion : ",
                auth_error_register: "√âchec de l'inscription : ",
                auth_error_reset: "√âchec de la r√©initialisation du mot de passe : "
            }
        };

        let currentLanguage = 'en'; // Lingua predefinita dell'app
        let currentTheme = 'dark'; // Tema predefinito √® scuro
        // Le variabili chatHistory e selectedChatbotLanguage sono gi√† dichiarate all'inizio del file.

        // Funzione per applicare le traduzioni
        function applyTranslations(lang) {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            // Aggiorna placeholder input chatbot
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.placeholder = translations[lang].chatbot_input_placeholder;
            }
            currentLanguage = lang;
        }

        // --- Funzioni di utilit√† ---
        function showPage(pageId) {
            console.log(`Showing page: ${pageId}`); // Debug log
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(pageId)?.classList.remove('hidden'); // Use optional chaining
            // Il pannello delle impostazioni √® stato rimosso, quindi non c'√® bisogno di gestirlo qui
        }

        function getContrastTextColor(hexColor) {
            const r = parseInt(hexColor.substring(1, 3), 16);
            const g = parseInt(hexColor.substring(3, 5), 16);
            const b = parseInt(hexColor.substring(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#333' : '#f0f0f0'; // Grigio scuro per sfondi chiari, grigio chiaro per sfondi scuri
        }

        function applyGradient(color1, color2, direction) {
            document.body.style.background = `linear-gradient(${direction}deg, ${color1}, ${color2})`;
            const textColor = getContrastTextColor(color1); // Usa il primo colore per la decisione del contrasto del testo

            // Applica il colore del testo agli elementi all'interno dei contenitori di vetro
            document.querySelectorAll('.glass-container h1, .glass-container h2, .glass-container h3, .glass-container p, .glass-container input, .glass-container textarea, .glass-container select').forEach(el => {
                el.style.color = textColor;
            });
            // Il colore del testo dei pulsanti si adatta al tema
            document.querySelectorAll('.link-button, .merch-button').forEach(el => {
                el.style.color = currentTheme === 'dark' ? '#f0f0f0' : '#333';
            });
        }

        // --- Toggle Tema ---
        function toggleTheme() {
            console.log("Toggling theme..."); // Debug log
            if (currentTheme === 'dark') {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                currentTheme = 'light';
                applyGradient('#a7bfe8', '#6190e8', 135); // Apply default light gradient
            } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                currentTheme = 'dark';
                applyGradient('#1a202c', '#2d3748', 135); // Apply default dark gradient
            }
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();

            // Aggiorna la classe della modale di autenticazione per il tema
            const authModalContent = document.querySelector('.auth-modal-content');
            if (authModalContent) {
                authModalContent.classList.toggle('light-mode-modal', currentTheme === 'light');
            }
            // Aggiorna la classe della chatbot modal per il tema
            const chatModalContent = document.querySelector('.chatbot-modal-content');
            if (chatModalContent) {
                chatModalContent.classList.toggle('light-mode-modal', currentTheme === 'light');
            }
        }

        function updateThemeIcon() {
            const themeIcon = document.getElementById('theme-toggle-icon');
            if (themeIcon) { // Check if element exists
                if (currentTheme === 'dark') {
                    themeIcon.textContent = SUN_EMOJI; // Icona Sole per la dark mode
                } else {
                    themeIcon.textContent = MOON_EMOJI; // Icona Luna per la light mode
                }
            }
        }

        // --- Casella Messaggi (sostituisce alert/confirm) ---
        function showMessageBox(message, type = 'alert', onConfirm = null) {
            console.log(`Showing message box: ${message} (Type: ${type})`); // Debug log
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-box-text');
            const okButton = document.getElementById('message-box-ok');
            const cancelButton = document.getElementById('message-box-cancel');

            if (!messageBox || !messageText || !okButton || !cancelButton) {
                console.error("One or more message box elements not found.");
                return;
            }

            messageText.textContent = message;
            okButton.textContent = translations[currentLanguage].message_box_ok;
            cancelButton.textContent = translations[currentLanguage].message_box_cancel;

            if (type === 'confirm') {
                cancelButton.classList.remove('hidden');
                okButton.onclick = () => {
                    messageBox.classList.add('hidden');
                    if (onConfirm) onConfirm(true);
                };
                cancelButton.onclick = () => {
                    messageBox.classList.add('hidden');
                    if (onConfirm) onConfirm(false);
                };
            } else { // 'alert'
                cancelButton.classList.add('hidden');
                okButton.onclick = () => {
                    messageBox.classList.add('hidden');
                };
            }
            messageBox.classList.remove('hidden');
            messageBox.classList.add('message-box-active'); // Aggiungi classe per animazione

            // Aggiorna il tema della message box
            const messageBoxContent = document.querySelector('.message-box-content');
            if (messageBoxContent) {
                messageBoxContent.classList.toggle('dark-mode-message-box', currentTheme === 'dark');
            }
        }

        // --- Logica Autenticazione Supabase e Database ---
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log("Supabase auth state changed:", event, session); // Debug log
            if (session?.user) {
                currentUserId = session.user.id;
                isAuthReady = true;
                const currentUserDisplay = document.getElementById('current-user-id-display');
                const dashboardUserDisplay = document.getElementById('dashboard-user-id-display');
                const logoutButton = document.getElementById('logout-button');

                if (currentUserDisplay) currentUserDisplay.textContent = currentUserId;
                if (dashboardUserDisplay) dashboardUserDisplay.textContent = currentUserId;
                if (logoutButton) logoutButton.classList.remove('hidden');
                console.log("Utente loggato (Supabase):", currentUserId);

                // Controlla se una pagina specifica √® richiesta tramite URL
                const urlParams = new URLSearchParams(window.location.search);
                const pageId = urlParams.get('pageId');
                if (pageId) {
                    await loadAboutMePage(pageId);
                } else {
                    await loadDashboard();
                }
            } else {
                currentUserId = null;
                isAuthReady = true;
                const currentUserDisplay = document.getElementById('current-user-id-display');
                const dashboardUserDisplay = document.getElementById('dashboard-user-id-display');
                const logoutButton = document.getElementById('logout-button');

                if (currentUserDisplay) currentUserDisplay.textContent = 'N/A';
                if (dashboardUserDisplay) dashboardUserDisplay.textContent = 'N/A';
                if (logoutButton) logoutButton.classList.add('hidden');
                console.log("Nessun utente loggato. Mostra la pagina di atterraggio.");
                showPage('landing-page');
            }
            applyTranslations(currentLanguage); // Applica le traduzioni dopo che l'autenticazione √® pronta
        });

        document.getElementById('signin-button')?.addEventListener('click', () => {
            console.log("Sign In / Register button clicked."); // Debug log
            showAuthModal('login');
        });

        async function saveAboutMePage(pageData, pageId = null) {
            console.log("Attempting to save page. Page ID:", pageId); // Debug log
            if (!isAuthReady || !currentUserId) {
                showMessageBox("Autenticazione non pronta. Riprova.");
                return null;
            }

            try {
                let response;
                if (pageId) {
                    // Aggiorna pagina esistente
                    response = await supabase
                        .from('aboutMePages')
                        .update(pageData)
                        .eq('id', pageId)
                        .select(); // Aggiungi .select() per ottenere i dati aggiornati
                    showMessageBox("Pagina aggiornata con successo!");
                } else {
                    // Crea nuova pagina
                    response = await supabase
                        .from('aboutMePages')
                        .insert([{ ...pageData, user_id: currentUserId }]) // Aggiungi user_id
                        .select(); // Aggiungi .select() per ottenere i dati inseriti
                    showMessageBox("Pagina creata con successo!");
                    pageId = response.data[0].id; // Ottieni l'ID del documento appena creato
                }

                if (response.error) throw response.error;

                await loadDashboard(); // Aggiorna la dashboard dopo il salvataggio
                return pageId;
            } catch (e) {
                console.error("Errore durante il salvataggio del documento: ", e);
                showMessageBox(translations[currentLanguage].error_saving_page + e.message);
                return null;
            }
        }

        async function deleteAboutMePage(pageId) {
            console.log("Attempting to delete page. Page ID:", pageId); // Debug log
            if (!isAuthReady || !currentUserId) {
                showMessageBox("Autenticazione non pronta. Riprova.");
                return;
            }

            showMessageBox(translations[currentLanguage].confirm_delete, 'confirm', async (confirmed) => {
                if (confirmed) {
                    try {
                        const { error } = await supabase
                            .from('aboutMePages')
                            .delete()
                            .eq('id', pageId)
                            .eq('user_id', currentUserId); // Assicurati che l'utente possa eliminare solo le proprie pagine
                        if (error) throw error;
                        showMessageBox("Pagina eliminata con successo!");
                        await loadDashboard(); // Aggiorna la dashboard
                    } catch (e) {
                        console.error("Errore durante la rimozione del documento: ", e);
                        showMessageBox(translations[currentLanguage].error_deleting_page + e.message);
                    }
                }
            });
        }

        async function loadDashboard() {
            console.log("Loading dashboard..."); // Debug log
            showPage('dashboard-page');
            const pagesListDiv = document.getElementById('dashboard-pages-list');
            if (!pagesListDiv) {
                console.error("Dashboard pages list element not found.");
                return;
            }
            pagesListDiv.innerHTML = `<p class="text-gray-600 text-center" data-i18n="dashboard_no_pages">${translations[currentLanguage].dashboard_no_pages}</p>`; // Messaggio predefinito

            if (!isAuthReady || !currentUserId) {
                console.warn("Autenticazione non pronta o nessun utente per il caricamento della dashboard.");
                return;
            }

            try {
                // Fetch delle pagine dell'utente da Supabase
                const { data, error } = await supabase
                    .from('aboutMePages')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('createdAt', { ascending: false }); // Assumendo una colonna createdAt

                if (error) throw error;

                pagesListDiv.innerHTML = ''; // Pulisci l'elenco precedente
                if (data.length === 0) {
                    pagesListDiv.innerHTML = `<p class="text-gray-600 text-center" data-i18n="dashboard_no_pages">${translations[currentLanguage].dashboard_no_pages}</p>`;
                } else {
                    data.forEach((page) => {
                        const pageId = page.id;
                        const pageCard = `
                            <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-xl p-4 shadow-md flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0 md:space-x-4 border border-white border-opacity-30">
                                <div class="flex-grow text-left">
                                    <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-100">${page.name || 'Pagina Senza Titolo'}</h4>
                                    <p class="text-gray-600 dark:text-gray-300 text-sm">${page.tagline || 'Nessuna tagline'}</p>
                                    <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">ID: ${pageId}</p>
                                </div>
                                <div class="flex flex-wrap justify-center md:justify-end gap-2">
                                    <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 view-page-btn" data-page-id="${pageId}" data-i18n="dashboard_view">${translations[currentLanguage].dashboard_view}</button>
                                    <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 edit-page-btn" data-page-id="${pageId}" data-i18n="dashboard_edit">${translations[currentLanguage].dashboard_edit}</button>
                                    <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 delete-page-btn" data-page-id="${pageId}" data-i18n="dashboard_delete">${translations[currentLanguage].dashboard_delete}</button>
                                    <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 copy-link-btn" data-page-id="${pageId}" data-i18n="dashboard_copy_link">${translations[currentLanguage].dashboard_copy_link}</button>
                                </div>
                            </div>
                        `;
                        pagesListDiv.insertAdjacentHTML('beforeend', pageCard);
                    });

                    // Collega i listener di eventi ai pulsanti appena creati
                    pagesListDiv.querySelectorAll('.view-page-btn').forEach(button => {
                        button.onclick = () => {
                            console.log("View page button clicked. ID:", button.dataset.pageId); // Debug log
                            const pageId = button.dataset.pageId;
                            window.history.pushState({}, '', `?pageId=${pageId}`);
                            loadAboutMePage(pageId);
                        };
                    });
                    pagesListDiv.querySelectorAll('.edit-page-btn').forEach(button => {
                        button.onclick = () => {
                            console.log("Edit page button clicked. ID:", button.dataset.pageId); // Debug log
                            const pageId = button.dataset.pageId;
                            openCreateEditForm(pageId);
                        };
                    });
                    pagesListDiv.querySelectorAll('.delete-page-btn').forEach(button => {
                        button.onclick = () => {
                            console.log("Delete page button clicked. ID:", button.dataset.pageId); // Debug log
                            const pageId = button.dataset.pageId;
                            deleteAboutMePage(pageId);
                        };
                    });
                    pagesListDiv.querySelectorAll('.copy-link-btn').forEach(button => {
                        button.onclick = () => {
                            console.log("Copy link button clicked. ID:", button.dataset.pageId); // Debug log
                            const pageId = button.dataset.pageId;
                            // Genera il link assoluto per la condivisione
                            const link = `${window.location.origin}${window.location.pathname}?pageId=${pageId}`;
                            navigator.clipboard.writeText(link).then(() => {
                                showMessageBox(translations[currentLanguage].dashboard_link_copied);
                            }).catch(err => {
                                console.error('Errore durante la copia del link: ', err);
                                // Fallback per browser pi√π vecchi o ambienti senza navigator.clipboard
                                const tempInput = document.createElement('textarea');
                                tempInput.value = link;
                                document.body.appendChild(tempInput);
                                tempInput.select();
                                document.execCommand('copy');
                                document.body.removeChild(tempInput);
                                showMessageBox(translations[currentLanguage].dashboard_link_copied + " (Copiato con fallback)");
                            });
                        };
                    });
                }
                applyTranslations(currentLanguage); // Riapplica le traduzioni per gli elementi aggiunti dinamicamente
            } catch (e) {
                console.error("Errore durante il caricamento delle pagine della dashboard: ", e);
                showMessageBox("Errore durante il caricamento delle pagine della dashboard: " + e.message);
            }
        }

        async function loadAboutMePage(pageId) {
            console.log("Loading AboutMe page for display. ID:", pageId); // Debug log
            showPage('about-me-display-page');
            // Il pannello delle impostazioni √® stato rimosso, quindi non c'√® bisogno di mostrarlo

            // Se l'utente non √® autenticato, prova a caricare la pagina in modalit√† pubblica
            // Altrimenti, carica la pagina solo se l'utente √® il proprietario
            let pageQuery = supabase
                .from('aboutMePages')
                .select('*')
                .eq('id', pageId);

            if (currentUserId) {
                pageQuery = pageQuery.eq('user_id', currentUserId);
            }

            try {
                console.log(`Tentativo di caricare la pagina con ID: ${pageId} per l'utente: ${currentUserId || 'non autenticato'}`);
                const { data: pageData, error } = await pageQuery.single();

                if (error) {
                    console.error("Errore Supabase durante il recupero della pagina:", error);
                    showMessageBox(translations[currentLanguage].error_loading_page + (error.message || "Pagina non trovata o non autorizzata."));
                    showPage('landing-page'); // Torna alla landing page in caso di errore o accesso non autorizzato
                    return;
                }

                if (pageData) {
                    console.log("Dati pagina caricati con successo:", pageData);

                    // Popola la sezione About Me
                    const displayProfileImg = document.getElementById('display-profile-img');
                    const displayName = document.getElementById('display-name');
                    const displayTagline = document.getElementById('display-tagline');
                    const displayAboutMeDescription = document.getElementById('display-about-me-description');

                    if (displayProfileImg) displayProfileImg.src = pageData.profileImgUrl || "https://placehold.co/140x140/6190e8/ffffff?text=Profile";
                    if (displayName) displayName.textContent = pageData.name || translations[currentLanguage].name;
                    if (displayTagline) displayTagline.textContent = pageData.tagline || translations[currentLanguage].tagline;
                    if (displayAboutMeDescription) displayAboutMeDescription.textContent = pageData.aboutMeDescription || translations[currentLanguage].about_me_description;

                    // Popola la sezione Link (gestione JSONB)
                    const linksContainer = document.getElementById('display-links-container');
                    if (linksContainer) linksContainer.innerHTML = '';
                    if (pageData.links && pageData.links.length > 0) {
                        pageData.links.forEach(link => {
                            const linkHtml = `
                                <a href="${link.url}" target="_blank" class="link-button">
                                    ${link.name}
                                </a>
                            `;
                            if (linksContainer) linksContainer.insertAdjacentHTML('beforeend', linkHtml);
                        });
                    } else {
                        if (linksContainer) linksContainer.innerHTML = `<p class="text-gray-600 dark:text-gray-300 text-center">Nessun link aggiunto.</p>`;
                    }

                    // Popola la sezione Merch (gestione JSONB)
                    const merchContainer = document.getElementById('display-merch-container');
                    if (merchContainer) merchContainer.innerHTML = '';
                    if (pageData.merch && pageData.merch.length > 0) {
                        pageData.merch.forEach(item => {
                            const merchHtml = `
                                <div class="merch-item text-left">
                                    <img src="${item.imageUrl || 'https://placehold.co/300x180/a7bfe8/ffffff?text=Merch'}" alt="${item.name}" class="merch-img mb-3">
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-1">${item.name}</h3>
                                    <p class="text-gray-600 dark:text-gray-300 mb-3">${item.description}</p>
                                    <a href="${item.buyLink}" target="_blank" class="merch-button text-sm">${translations[currentLanguage].merch_buy_now} (${item.price})</a>
                                </div>
                            `;
                            if (merchContainer) merchContainer.insertAdjacentHTML('beforeend', merchHtml);
                        });
                    } else {
                        if (merchContainer) merchContainer.innerHTML = `<p class="text-gray-600 dark:text-gray-300 text-center">Nessun articolo merch aggiunto.</p>`;
                    }

                    // Applica le impostazioni (lingua dell'app e gradiente di base)
                    // Le impostazioni di gradiente e lingua della pagina non sono pi√π persistenti nel DB per singola pagina
                    // e sono controllate dal tema generale dell'app.
                    applyGradient(
                        currentTheme === 'dark' ? '#1a202c' : '#a7bfe8',
                        currentTheme === 'dark' ? '#2d3748' : '#6190e8',
                        135 // Direzione gradiente predefinita
                    );
                    applyTranslations(currentLanguage); // Applica la lingua dell'app
                } else {
                    console.log("Nessun documento trovato per l'ID specificato o per l'utente corrente.");
                    showMessageBox(translations[currentLanguage].error_loading_page + "Pagina non trovata.");
                    showPage('dashboard-page'); // Torna alla dashboard se la pagina non viene trovata
                }
            } catch (e) {
                console.error("Errore durante il recupero del documento:", e);
                showMessageBox(translations[currentLanguage].error_loading_page + e.message);
                showPage('dashboard-page'); // Torna alla dashboard in caso di errore
            }
        }

        let editingPageId = null; // Per tenere traccia se stiamo modificando o creando

        // Funzione per impostare i listener di caricamento immagine per un'area specifica
        async function uploadImageToSupabase(file, userId) {
            console.log("Attempting to upload image for user:", userId); // Debug log
            const fileName = `${userId}/${Date.now()}-${file.name}`;
            try {
                const { data, error } = await supabase.storage
                    .from('profile-images') // Assicurati che questo bucket esista in Supabase Storage
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                const { data: publicUrlData } = supabase.storage
                    .from('profile-images')
                    .getPublicUrl(fileName);

                if (publicUrlData && publicUrlData.publicUrl) {
                    return publicUrlData.publicUrl;
                } else {
                    throw new Error("Impossibile ottenere l'URL pubblico dell'immagine.");
                }
            } catch (e) {
                console.error("Errore durante il caricamento dell'immagine in Supabase:", e);
                throw e; // Rilancia l'errore per gestirlo nel chiamante
            }
        }

        function setupImageUpload(uploadAreaId, fileInputId, previewImgId, uploadTextId, hiddenUrlInputId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            const previewImg = document.getElementById(previewImgId);
            const uploadText = document.getElementById(uploadTextId);
            const hiddenUrlInput = document.getElementById(hiddenUrlInputId);

            if (!uploadArea || !fileInput || !previewImg || !uploadText || !hiddenUrlInput) {
                console.error("Elementi di caricamento immagine non trovati per ID:", { uploadAreaId, fileInputId, previewImgId, uploadTextId, hiddenUrlInputId });
                return;
            }

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop area when dragging over
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('border-blue-500', 'bg-opacity-40'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('border-blue-500', 'bg-opacity-40'), false);
            });

            // Handle dropped files
            uploadArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);

            // Handle file input click
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            async function handleFiles(files) {
                if (files.length === 0) return;

                const file = files[0];
                if (!file.type.startsWith('image/')) {
                    showMessageBox("Si prega di caricare un file immagine valido.");
                    return;
                }

                if (!currentUserId) {
                    showMessageBox("Devi essere loggato per caricare immagini.");
                    uploadText.textContent = translations[currentLanguage].form_profile_img_upload; // Reset text
                    previewImg.src = "https://placehold.co/140x140/6190e8/ffffff?text=Image"; // Reset preview on error
                    hiddenUrlInput.value = '';
                    return;
                }

                uploadText.textContent = "Caricamento in corso...";
                previewImg.src = "https://placehold.co/140x140/cccccc/333333?text=Loading...";

                try {
                    const publicUrl = await uploadImageToSupabase(file, currentUserId);
                    hiddenUrlInput.value = publicUrl;
                    previewImg.src = publicUrl;
                    uploadText.textContent = translations[currentLanguage].upload_success;
                    showMessageBox(translations[currentLanguage].upload_success);
                } catch (e) {
                    console.error("Errore durante il caricamento dell'immagine:", e);
                    showMessageBox(translations[currentLanguage].upload_error + e.message);
                    uploadText.textContent = translations[currentLanguage].form_profile_img_upload;
                    previewImg.src = "https://placehold.co/140x140/6190e8/ffffff?text=Image"; // Reset preview on error
                    hiddenUrlInput.value = '';
                }
            }
        }


        function openCreateEditForm(pageId = null) {
            console.log("Opening create/edit form. Editing ID:", pageId); // Debug log
            showPage('create-edit-form');
            editingPageId = pageId;

            const formTitle = document.getElementById('create-edit-form-title');
            const nameInput = document.getElementById('form-name');
            const taglineInput = document.getElementById('form-tagline');
            const aboutMeInput = document.getElementById('form-about-me');
            const profileImgPreview = document.getElementById('profile-img-preview');
            const profileImgUploadText = document.getElementById('profile-img-upload-text');
            const fileInput = document.getElementById('profile-img-file-input');
            const profileImgUrlInput = document.getElementById('form-profile-img-url-hidden'); // Il campo URL nascosto

            const linksContainer = document.getElementById('form-links-container');
            const merchContainer = document.getElementById('form-merch-container');

            // Pulisci il modulo
            if (nameInput) nameInput.value = '';
            if (taglineInput) taglineInput.value = '';
            if (aboutMeInput) aboutMeInput.value = '';
            if (profileImgUrlInput) profileImgUrlInput.value = ''; // Pulisci anche l'input URL nascosto
            if (profileImgPreview) profileImgPreview.src = "https://placehold.co/140x140/6190e8/ffffff?text=Profile"; // Reset preview
            if (profileImgUploadText) profileImgUploadText.textContent = translations[currentLanguage].form_profile_img_upload; // Reset text
            if (fileInput) fileInput.value = ''; // Reset file input
            if (linksContainer) linksContainer.innerHTML = '';
            if (merchContainer) merchContainer.innerHTML = '';

            if (pageId) {
                if (formTitle) formTitle.textContent = translations[currentLanguage].create_edit_title_edit;
                // Carica i dati per la modifica
                supabase
                    .from('aboutMePages')
                    .select('*')
                    .eq('id', pageId)
                    .eq('user_id', currentUserId)
                    .single()
                    .then(({ data, error }) => {
                        if (error) throw error;
                        if (data) {
                            if (nameInput) nameInput.value = data.name || '';
                            if (taglineInput) taglineInput.value = data.tagline || '';
                            if (aboutMeInput) aboutMeInput.value = data.aboutMeDescription || '';
                            if (profileImgUrlInput) profileImgUrlInput.value = data.profileImgUrl || ''; // Imposta l'URL nascosto
                            if (profileImgPreview) profileImgPreview.src = data.profileImgUrl || "https://placehold.co/140x140/6190e8/ffffff?text=Profile"; // Aggiorna preview
                            if (profileImgUploadText) profileImgUploadText.textContent = data.profileImgUrl ? 'Immagine caricata' : translations[currentLanguage].form_profile_img_upload;


                            if (data.links) {
                                data.links.forEach(link => addLinkForm(link.name, link.url));
                            }
                            if (data.merch) {
                                data.merch.forEach(item => addMerchForm(item.name, item.description, item.imageUrl, item.price, item.buyLink));
                            }
                        }
                    })
                    .catch(e => {
                        console.error("Errore durante il caricamento della pagina per la modifica:", e);
                        showMessageBox("Errore durante il caricamento della pagina per la modifica: " + e.message);
                    });
            } else {
                if (formTitle) formTitle.textContent = translations[currentLanguage].create_edit_title_create;
                // Aggiungi campi iniziali vuoti per la nuova pagina
                addLinkForm();
                addMerchForm();
            }
            applyTranslations(currentLanguage); // Riapplica le traduzioni per gli elementi del modulo
        }

        function addLinkForm(name = '', url = '') {
            console.log("Adding link form."); // Debug log
            const container = document.getElementById('form-links-container');
            if (!container) {
                console.error("Links container not found.");
                return;
            }
            const div = document.createElement('div');
            div.className = 'flex flex-col md:flex-row gap-2 mb-2';
            div.innerHTML = `
                <input type="text" placeholder="${translations[currentLanguage].form_links_title.split('(')[0].trim()} Nome" value="${name}" class="link-name-input p-2 rounded-lg bg-white bg-opacity-30 border border-white border-opacity-40 flex-grow dark:bg-gray-700 dark:bg-opacity-30 dark:border-gray-600 dark:text-gray-100">
                <input type="url" placeholder="${translations[currentLanguage].form_links_title.split('(')[0].trim()} URL" value="${url}" class="link-url-input p-2 rounded-lg bg-white bg-opacity-30 border border-white border-opacity-40 flex-grow dark:bg-gray-700 dark:bg-opacity-30 dark:border-gray-600 dark:text-gray-100">
                <button class="remove-link-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition duration-200">X</button>
            `;
            container.appendChild(div);
            div.querySelector('.remove-link-btn')?.addEventListener('click', () => { // Use optional chaining for safety
                console.log("Remove link button clicked."); // Debug log
                div.remove();
            });
        }

        function addMerchForm(name = '', description = '', imageUrl = '', price = '', buyLink = '') {
            console.log("Adding merch form."); // Debug log
            const container = document.getElementById('form-merch-container');
            if (!container) {
                console.error("Merch container not found.");
                return;
            }
            const div = document.createElement('div');
            const uniqueId = Date.now() + Math.random().toString(36).substring(2, 9); // Unique ID for each merch item's image elements
            div.className = 'flex flex-col gap-2 mb-4 p-3 border border-white border-opacity-40 rounded-lg bg-white bg-opacity-20 dark:bg-gray-800 dark:bg-opacity-20 dark:border-gray-700';
            div.innerHTML = `
                <input type="text" placeholder="${translations[currentLanguage].form_merch_title.split('(')[0].trim()} Nome" value="${name}" class="merch-name-input p-2 rounded-lg bg-white bg-opacity-30 border border-white border-opacity-40 dark:bg-gray-700 dark:bg-opacity-30 dark:border-gray-600 dark:text-gray-100">
                <textarea placeholder="${translations[currentLanguage].form_merch_title.split('(')[0].trim()} Descrizione" class="merch-desc-input p-2 rounded-lg bg-white bg-opacity-30 border border-white border-opacity-40 h-20 dark:bg-gray-700 dark:bg-opacity-30 dark:border-gray-600 dark:text-gray-100">${description}</textarea>

                <div id="merch-img-upload-area-${uniqueId}" class="upload-area mt-2">
                    <img id="merch-img-preview-${uniqueId}" src="${imageUrl || 'https://placehold.co/140x140/6190e8/ffffff?text=Merch'}" alt="Merch Image Preview">
                    <p id="merch-img-upload-text-${uniqueId}" class="text-gray-600 dark:text-gray-300">${translations[currentLanguage].form_profile_img_upload}</p>
                    <input type="file" id="merch-img-file-input-${uniqueId}" accept="image/*" class="hidden">
                </div>
                <input type="hidden" id="merch-img-url-hidden-${uniqueId}" value="${imageUrl}"> <!-- Hidden input for URL -->

                <input type="text" placeholder="${translations[currentLanguage].form_merch_title.split('(')[0].trim()} Prezzo (es. $25)" value="${price}" class="merch-price-input p-2 rounded-lg bg-white bg-opacity-30 border border-white border-opacity-40 dark:bg-gray-700 dark:bg-opacity-30 dark:border-gray-600 dark:text-gray-100">
                <input type="url" placeholder="${translations[currentLanguage].form_merch_title.split('(')[0].trim()} Link Acquisto" value="${buyLink}" class="merch-buy-link-input p-2 rounded-lg bg-white bg-opacity-30 border border-white border-opacity-40 dark:bg-gray-700 dark:bg-opacity-30 dark:border-gray-600 dark:text-gray-100">
                <button class="remove-merch-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition duration-200 self-end">X</button>
            `;
            container.appendChild(div);
            div.querySelector('.remove-merch-btn')?.addEventListener('click', () => { // Use optional chaining for safety
                console.log("Remove merch button clicked."); // Debug log
                div.remove();
            });

            // Setup image upload for this new merch item
            setupImageUpload(
                `merch-img-upload-area-${uniqueId}`,
                `merch-img-file-input-${uniqueId}`,
                `merch-img-preview-${uniqueId}`,
                `merch-img-upload-text-${uniqueId}`,
                `merch-img-url-hidden-${uniqueId}`
            );
        }

        document.getElementById('form-add-link-btn')?.addEventListener('click', () => {
            console.log("Add link button clicked."); // Debug log
            addLinkForm();
        });
        document.getElementById('form-add-merch-btn')?.addEventListener('click', () => {
            console.log("Add merch button clicked."); // Debug log
            addMerchForm();
        });

        document.getElementById('form-save-btn')?.addEventListener('click', async () => {
            console.log("Save page button clicked."); // Debug log
            const name = document.getElementById('form-name')?.value;
            const tagline = document.getElementById('form-tagline')?.value;
            const aboutMeDescription = document.getElementById('form-about-me')?.value;
            const profileImgUrl = document.getElementById('form-profile-img-url-hidden')?.value; // Ottieni l'URL dall'input nascosto

            const links = [];
            document.querySelectorAll('#form-links-container > div').forEach(div => {
                const nameInput = div.querySelector('.link-name-input');
                const urlInput = div.querySelector('.link-url-input');
                if (nameInput && urlInput) { // Ensure elements exist
                    const name = nameInput.value;
                    const url = urlInput.value;
                    if (name && url) links.push({ name, url });
                }
            });

            const merch = [];
            document.querySelectorAll('#form-merch-container > div').forEach(div => {
                const nameInput = div.querySelector('.merch-name-input');
                const descInput = div.querySelector('.merch-desc-input');
                const imageUrlInput = div.querySelector('input[type="hidden"]');
                const priceInput = div.querySelector('.merch-price-input');
                const buyLinkInput = div.querySelector('.merch-buy-link-input');

                if (nameInput && descInput && imageUrlInput && priceInput && buyLinkInput) { // Ensure elements exist
                    const name = nameInput.value;
                    const description = descInput.value;
                    const imageUrl = imageUrlInput.value;
                    const price = priceInput.value;
                    const buyLink = buyLinkInput.value;
                    if (name) merch.push({ name, description, imageUrl, price, buyLink });
                }
            });

            const pageData = {
                name,
                tagline,
                aboutMeDescription,
                profileImgUrl,
                links,
                merch
                // Le impostazioni di lingua e gradiente non sono pi√π salvate per pagina
            };

            const savedPageId = await saveAboutMePage(pageData, editingPageId);
            if (savedPageId) {
                // Opzionalmente reindirizza alla pagina appena creata/modificata o torna alla dashboard
                await loadDashboard();
            }
        });

        document.getElementById('form-cancel-btn')?.addEventListener('click', () => {
            console.log("Cancel form button clicked."); // Debug log
            loadDashboard();
        });

        document.getElementById('dashboard-create-new-btn')?.addEventListener('click', () => {
            console.log("Create New AboutMe Page button clicked."); // Debug log
            openCreateEditForm();
        });

        // --- Logica Modale Autenticazione ---
        const authModal = document.getElementById('auth-modal');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form'); // Corrected typo here
        const authModalTitle = document.getElementById('auth-modal-title');
        const authMessage = document.getElementById('auth-message');

        function showAuthModal(formType) {
            console.log("Showing auth modal. Form type:", formType); // Debug log
            if (authModal) authModal.classList.remove('hidden');
            if (authModal) authModal.classList.add('auth-modal-active'); // Aggiungi classe per animazione
            // Aggiorna la classe della modale di autenticazione per il tema corrente
            const authModalContent = document.querySelector('.auth-modal-content');
            if (authModalContent) {
                authModalContent.classList.toggle('light-mode-modal', currentTheme === 'light');
            }

            if (authMessage) authMessage.textContent = ''; // Pulisci i messaggi precedenti
            if (document.getElementById('auth-email')) document.getElementById('auth-email').value = '';
            if (document.getElementById('auth-password')) document.getElementById('auth-password').value = '';
            if (document.getElementById('auth-forgot-email')) document.getElementById('auth-forgot-email').value = '';
            // Resetta i campi email e password del form di registrazione
            if (document.getElementById('auth-email-register')) document.getElementById('auth-email-register').value = '';
            if (document.getElementById('auth-password-register')) document.getElementById('auth-password-register').value = '';
            if (document.getElementById('auth-confirm-password-register')) document.getElementById('auth-confirm-password-register').value = ''; // Resetta anche la conferma password
            if (document.getElementById('password-match-message')) document.getElementById('password-match-message').textContent = ''; // Pulisci il messaggio di corrispondenza password

            // Resetta la visibilit√† delle password e la variabile di tracciamento
            resetPasswordVisibility();

            if (loginForm) loginForm.classList.add('hidden');
            if (registerForm) registerForm.classList.add('hidden');
            if (forgotPasswordForm) forgotPasswordForm.classList.add('hidden');

            if (formType === 'login') {
                if (loginForm) loginForm.classList.remove('hidden');
                if (authModalTitle) authModalTitle.textContent = translations[currentLanguage].auth_modal_title_login;
            } else if (formType === 'register') {
                if (registerForm) registerForm.classList.remove('hidden');
                if (authModalTitle) authModalTitle.textContent = translations[currentLanguage].auth_modal_title_register;
            } else if (formType === 'forgot') {
                if (forgotPasswordForm) forgotPasswordForm.classList.remove('hidden');
                if (authModalTitle) authModalTitle.textContent = translations[currentLanguage].auth_modal_title_forgot;
            }
            applyTranslations(currentLanguage); // Riapplica le traduzioni per il contenuto della modale
        }

        document.getElementById('auth-modal-close')?.addEventListener('click', () => {
            console.log("Auth modal close button clicked."); // Debug log
            if (authModal) authModal.classList.add('hidden');
            if (authModal) authModal.classList.remove('auth-modal-active'); // Rimuovi classe per animazione
            resetPasswordVisibility(); // Resetta la visibilit√† delle password alla chiusura
        });

        document.getElementById('go-to-register')?.addEventListener('click', () => {
            console.log("Go to register link clicked."); // Debug log
            showAuthModal('register');
        });
        document.getElementById('go-to-login')?.addEventListener('click', () => {
            console.log("Go to login link clicked."); // Debug log
            showAuthModal('login');
        });
        document.getElementById('forgot-password-link')?.addEventListener('click', () => {
            console.log("Forgot password link clicked."); // Debug log
            showAuthModal('forgot');
        });
        document.getElementById('go-to-login-from-forgot')?.addEventListener('click', () => {
            console.log("Go to login from forgot password link clicked."); // Debug log
            showAuthModal('login');
        });

        // Funzione per resettare la visibilit√† di tutte le password
        function resetPasswordVisibility() {
            document.querySelectorAll('.password-input').forEach(input => {
                input.type = 'password';
            });
            document.querySelectorAll('.toggle-password-btn').forEach(button => {
                button.innerHTML = EYE_OPEN_SVG; // Reset all buttons to eye open
            });
            currentlyVisiblePasswordInputId = null;
        }

        // Funzione universale per mostrare/nascondere la password
        function togglePasswordVisibility(inputElementId, buttonElementId) {
            const inputElement = document.getElementById(inputElementId);
            const buttonElement = document.getElementById(buttonElementId);

            if (!inputElement || !buttonElement) { // Ensure elements exist
                console.error(`Password toggle elements not found for ID: ${inputElementId}, ${buttonElementId}`);
                return;
            }

            if (currentlyVisiblePasswordInputId === inputElementId) {
                // Se √® la stessa password gi√† visibile, nascondila
                inputElement.type = 'password';
                buttonElement.innerHTML = EYE_OPEN_SVG;
                currentlyVisiblePasswordInputId = null;
            } else {
                // Se c'√® un'altra password visibile, nascondila prima
                if (currentlyVisiblePasswordInputId) {
                    const prevInput = document.getElementById(currentlyVisiblePasswordInputId);
                    // Trova il pulsante associato all'input precedentemente visibile
                    let prevButton = null;
                    if (currentlyVisiblePasswordInputId === 'auth-password') {
                        prevButton = document.getElementById('toggle-password-login');
                    } else if (currentlyVisiblePasswordInputId === 'auth-password-register') {
                        prevButton = document.getElementById('toggle-password-register');
                    } else if (currentlyVisiblePasswordInputId === 'auth-confirm-password-register') {
                        prevButton = document.getElementById('toggle-confirm-password-register');
                    }

                    if (prevInput && prevButton) {
                        prevInput.type = 'password';
                        prevButton.innerHTML = EYE_OPEN_SVG;
                    }
                }
                // Mostra la nuova password
                inputElement.type = 'text';
                buttonElement.innerHTML = EYE_CLOSED_SVG;
                currentlyVisiblePasswordInputId = inputElementId;
            }
        }

        // Event Listeners per i pulsanti mostra/nascondi password
        document.getElementById('toggle-password-login')?.addEventListener('click', () => {
            console.log("Toggle password login button clicked."); // Debug log
            togglePasswordVisibility('auth-password', 'toggle-password-login');
        });
        document.getElementById('toggle-password-register')?.addEventListener('click', () => {
            console.log("Toggle password register button clicked."); // Debug log
            togglePasswordVisibility('auth-password-register', 'toggle-password-register');
        });
        document.getElementById('toggle-confirm-password-register')?.addEventListener('click', () => {
            console.log("Toggle confirm password register button clicked."); // Debug log
            togglePasswordVisibility('auth-confirm-password-register', 'toggle-confirm-password-register');
        });


        document.getElementById('login-button')?.addEventListener('click', async () => {
            console.log("Login button clicked."); // Debug log
            const emailInput = document.getElementById('auth-email');
            const passwordInput = document.getElementById('auth-password');
            if (!emailInput || !passwordInput) {
                console.error("Email or password input for login not found.");
                return;
            }
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                if (authModal) authModal.classList.add('hidden');
                if (authModal) authModal.classList.remove('auth-modal-active');
                showMessageBox("Accesso effettuato con successo!");
            } catch (error) {
                console.error("Errore di accesso:", error);
                if (authMessage) authMessage.textContent = translations[currentLanguage].auth_error_login + error.message;
            }
        });

        // Funzione per controllare la corrispondenza delle password (Registrazione)
        const passwordRegister = document.getElementById('auth-password-register');
        const confirmPasswordRegister = document.getElementById('auth-confirm-password-register');
        const passwordMatchMessage = document.getElementById('password-match-message');

        function checkPasswordsMatch() {
            if (!passwordRegister || !confirmPasswordRegister || !passwordMatchMessage) {
                console.error("Password match elements not found.");
                return false;
            }
            if (passwordRegister.value === '' && confirmPasswordRegister.value === '') {
                passwordMatchMessage.textContent = '';
                passwordMatchMessage.className = '';
                return false;
            }
            if (passwordRegister.value === confirmPasswordRegister.value) {
                passwordMatchMessage.textContent = translations[currentLanguage].auth_passwords_match;
                passwordMatchMessage.className = 'text-green-500 text-sm mt-2';
                return true;
            } else {
                passwordMatchMessage.textContent = translations[currentLanguage].auth_passwords_no_match;
                passwordMatchMessage.className = 'text-red-500 text-sm mt-2';
                return false;
            }
        }

        passwordRegister?.addEventListener('input', checkPasswordsMatch);
        confirmPasswordRegister?.addEventListener('input', checkPasswordsMatch);


        document.getElementById('register-button')?.addEventListener('click', async () => {
            console.log("Register button clicked."); // Debug log
            const emailInput = document.getElementById('auth-email-register');
            const passwordInput = document.getElementById('auth-password-register');

            if (!emailInput || !passwordInput) {
                console.error("Email or password input for register not found.");
                return;
            }

            const email = emailInput.value;
            const password = passwordInput.value;

            if (!checkPasswordsMatch()) {
                if (authMessage) authMessage.textContent = translations[currentLanguage].auth_passwords_no_match;
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                if (authModal) authModal.classList.add('hidden');
                if (authModal) authModal.classList.remove('auth-modal-active');
                showMessageBox("Registrazione effettuata con successo! Ora sei loggato.");
            } catch (error) {
                console.error("Errore di registrazione:", error);
                if (authMessage) authMessage.textContent = translations[currentLanguage].auth_error_register + error.message;
            }
        });

        document.getElementById('reset-password-button')?.addEventListener('click', async () => {
            console.log("Reset password button clicked."); // Debug log
            const emailInput = document.getElementById('auth-forgot-email');
            if (!emailInput) {
                console.error("Email input for forgot password not found.");
                return;
            }
            const email = emailInput.value;
            if (!email) {
                if (authMessage) authMessage.textContent = "Inserisci il tuo indirizzo email.";
                return;
            }
            try {
                const { data, error } = await supabase.auth.resetPasswordForEmail(email);
                if (error) throw error;
                if (authMessage) authMessage.textContent = translations[currentLanguage].auth_reset_email_sent;
                // Opzionalmente, nascondi il modulo dopo un breve ritardo
                setTimeout(() => {
                    if (authModal) authModal.classList.add('hidden');
                    if (authModal) authModal.classList.remove('auth-modal-active');
                }, 3000);
            } catch (error) {
                console.error("Errore di reimpostazione password:", error);
                if (authMessage) authMessage.textContent = translations[currentLanguage].auth_error_reset + error.message;
            }
        });

        // Impedisci il comportamento predefinito del browser per il drag & drop sull'intera pagina
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        document.body.addEventListener('dragenter', preventDefaults, false);
        document.body.addEventListener('dragover', preventDefaults, false);
        document.body.addEventListener('dragleave', preventDefaults, false);
        document.body.addEventListener('drop', preventDefaults, false);


        // --- Chatbot AI Logic ---
        function toggleChatbot() {
            console.log("Toggling chatbot."); // Debug log
            const chatbotModal = document.getElementById('chatbot-modal');
            if (!chatbotModal) {
                console.error("Chatbot modal element not found.");
                return;
            }
            chatbotModal.classList.toggle('hidden');
            chatbotModal.classList.toggle('chatbot-modal-active');
            // Aggiorna la classe della chatbot modal per il tema corrente
            const chatModalContent = document.querySelector('.chatbot-modal-content');
            if (chatModalContent) {
                chatModalContent.classList.toggle('light-mode-modal', currentTheme === 'light');
            }
            // Scrolla in basso quando si apre la chat
            const chatMessages = document.getElementById('chat-messages');
            if (!chatbotModal.classList.contains('hidden')) {
                // Se la chat √® aperta e la cronologia √® vuota, invia il prompt iniziale per la lingua
                if (chatHistory.length === 0) {
                    appendMessage('ai', "Hello! I am your AboutMe AI Assistant. What language would you like me to respond in? (e.g., English, Italian, German, French)");
                }
                if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            applyTranslations(currentLanguage); // Applica le traduzioni per la chatbot (UI)
        }

        function appendMessage(sender, message) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) {
                console.error("Chat messages container not found.");
                return;
            }
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-2', 'p-2', 'rounded-lg', 'max-w-[80%]');

            if (sender === 'user') {
                messageElement.classList.add('bg-blue-500', 'text-white', 'self-end', 'ml-auto', 'rounded-br-none');
            } else {
                messageElement.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'mr-auto', 'rounded-bl-none');
                // Adatta il colore del testo del messaggio AI al tema
                if (currentTheme === 'dark') {
                    messageElement.classList.remove('bg-gray-200', 'text-gray-800');
                    messageElement.classList.add('bg-gray-700', 'text-gray-100');
                }
            }
            messageElement.textContent = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scrolla in basso
        }

        async function sendMessageToGemini() {
            console.log("Sending message to Gemini."); // Debug log
            const chatInput = document.getElementById('chat-input');
            if (!chatInput) {
                console.error("Chat input element not found.");
                return;
            }
            const message = chatInput.value.trim();
            if (!message) return;

            appendMessage('user', message);
            chatInput.value = ''; // Pulisci l'input

            const loadingIndicator = document.getElementById('chatbot-loading');
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');

            const lowerCaseMessage = message.toLowerCase();
            // Expanded keywords for external queries
            const externalSiteKeywords = [
                "sito esterno", "altro sito", "link esterno", "ricerca web", "google", "wikipedia",
                "trova su internet", "informazioni su", "cos'√®", "dimmi di", "notizie su",
                "qual √® la capitale", "meteo", "ricetta", "storia di", "come si fa", "spiegami",
                "what is", "tell me about", "news about", "capital of", "weather", "recipe", "history of", "how to", "explain" // Added English keywords
            ];
            if (externalSiteKeywords.some(keyword => lowerCaseMessage.includes(keyword))) {
                appendMessage('ai', translations[currentLanguage].chatbot_external_query_response + ' ' + getRandomChatbotEmoji());
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                return;
            }

            let geminiPrompt = message;
            if (chatHistory.length === 0) { // Primo messaggio dell'utente, prova a rilevare la lingua
                if (lowerCaseMessage.includes('italian') || lowerCaseMessage.includes('italiano')) {
                    selectedChatbotLanguage = 'it';
                } else if (lowerCaseMessage.includes('german') || lowerCaseMessage.includes('tedesco')) {
                    selectedChatbotLanguage = 'de';
                } else if (lowerCaseMessage.includes('french') || lowerCaseMessage.includes('francese')) {
                    selectedChatbotLanguage = 'fr';
                } else {
                    selectedChatbotLanguage = 'en'; // Predefinito se non riconosciuto
                }
                // Aggiungi l'istruzione per risposte concise e specifiche del sito
                geminiPrompt = `Rispondi in modo molto conciso e riassuntivo, esclusivamente su domande relative al sito "AboutMe" e alle sue funzionalit√†. Se la domanda non riguarda il sito, dichiara che non puoi rispondere. Rispondi in ${selectedChatbotLanguage === 'en' ? 'Inglese' : selectedChatbotLanguage === 'it' ? 'Italiano' : selectedChatbotLanguage === 'de' ? 'Tedesco' : 'Francese'}. Domanda: ${message}`;
            } else {
                // Per i messaggi successivi, assicurati che Gemini continui nella lingua selezionata e sia conciso e specifico del sito
                geminiPrompt = `Continua la conversazione in modo molto conciso e riassuntivo, esclusivamente su domande relative al sito "AboutMe" e alle sue funzionalit√†. Se la domanda non riguarda il sito, dichiara che non puoi rispondere. Rispondi in ${selectedChatbotLanguage === 'en' ? 'Inglese' : selectedChatbotLanguage === 'it' ? 'Italiano' : selectedChatbotLanguage === 'de' ? 'Tedesco' : 'Francese'}. Domanda: ${message}`;
            }

            chatHistory.push({ role: "user", parts: [{ text: geminiPrompt }] }); // Aggiungi il prompt modificato alla cronologia

            try {
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log("Gemini API response:", result); // Debug: Controlla la risposta di Gemini

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    // Rimuovi eventuali asterischi dalla risposta di Gemini
                    const cleanAiResponse = aiResponse.replace(/\*/g, '');
                    appendMessage('ai', cleanAiResponse + ' ' + getRandomChatbotEmoji());
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    appendMessage('ai', "Mi dispiace, non sono riuscito a generare una risposta. Riprova pi√π tardi." + ' ' + getRandomChatbotEmoji());
                    console.error("Risposta Gemini inattesa:", result);
                }
            } catch (error) {
                console.error("Errore durante la chiamata all'API Gemini:", error);
                appendMessage('ai', "Si √® verificato un errore durante la comunicazione con l'assistente AI." + ' ' + getRandomChatbotEmoji());
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            }
        }

        // Caricamento iniziale del tema
        window.onload = () => {
            console.log("Window loaded. Initializing app."); // Debug log
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.body.classList.add(`${currentTheme}-mode`);
            } else {
                // Predefinito in modalit√† scura se nessuna preferenza √® salvata
                document.body.classList.add('dark-mode');
                currentTheme = 'dark';
            }
            updateThemeIcon(); // Imposta l'icona corretta in base al tema caricato
            // Applica il gradiente iniziale predefinito in base al tema caricato
            if (currentTheme === 'dark') {
                applyGradient('#1a202c', '#2d3748', 135);
            } else {
                applyGradient('#a7bfe8', '#6190e8', 135);
            }

            // Aggiungi l'event listener per il pulsante del tema
            document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);

            // Aggiungi l'event listener per il pulsante di logout qui per assicurarti che il DOM sia caricato
            document.getElementById('logout-button')?.addEventListener('click', async () => {
                console.log("Logout button clicked."); // Debug: Conferma il click
                try {
                    console.log("Attempting to sign out with Supabase auth:", supabase.auth); // Debug: Controlla l'oggetto auth
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.error("Supabase signOut error:", error); // Log di errore pi√π specifico
                        throw error;
                    }
                    showMessageBox("Disconnessione effettuata con successo!");
                    showPage('landing-page');
                    console.log("Logout successful, redirecting to landing page."); // Debug: Conferma il successo del logout
                } catch (error) {
                    console.error("Errore durante la disconnessione:", error);
                    showMessageBox("Errore durante la disconnessione: " + error.message);
                }
            });

            // Event listeners per il chatbot
            document.getElementById('chatbot-toggle-btn')?.addEventListener('click', toggleChatbot);
            document.getElementById('chatbot-close-btn')?.addEventListener('click', toggleChatbot);
            document.getElementById('chat-send-btn')?.addEventListener('click', sendMessageToGemini);
            document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessageToGemini();
                }
            });

            // Setup per il caricamento dell'immagine del profilo principale
            setupImageUpload(
                'profile-img-upload-area',
                'profile-img-file-input',
                'profile-img-preview',
                'profile-img-upload-text',
                'form-profile-img-url-hidden'
            );
        };

    </script>
</body>
</html>
